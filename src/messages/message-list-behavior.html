<script>
  MessageListBehavior = {

    properties: { 
      messages: {
        type: Array,
        value: [],
      },
      selection: {
        type: Array,
      },
      selectionSize: {
        type: Number,
        computed: '_computedSelectionSize(selection.*)',
        notify: true,
      },
      hasSelection: {
        type: Boolean,
        computed: '_computedHasSelection(selection.*)',
        notify: true,
      },
    },

    onSelectAll: function() {
      var i = 0; 
      var messages = this.filtered ? this.filtered : this.messages;
      var list = this._getList();
      var processChunk = function() {
        var items = messages.slice(i, i + 111);
        items.forEach(function(item, j) {
          list.selectItem(item);
        }, this);
        i += items.length;
        if (i < messages.length) {
          if (!this._spinner || !this._spinner.loading) {
            this._showSpinner()
          }
          window.setTimeout(processChunk, 2);
        } else {
          console.log('== select all complete ==');
          this._hideSpinner();
          this._selectAllComplete();
        }
      }.bind(this);
      if (messages.length) {
        processChunk();
      }
    },

    onUnselectAll: function() {
      this._getList().clearSelection();
      this.selection = [];
    },

    onSelectedToggled: function(e) {
      var list = this._getList();
      e.model.selected ? list.deselectItem(e.model.index) 
                       : list.selectItem(e.model.index);
    },

    notifyResize: function() {
      this._getList().notifyResize();
    },

    onResize: function() {
      this._updateGeometry();
    },

    _computedSelectionSize: function() {
      return this.selection.length;
    },

    _computedHasSelection: function() {
      return !!this.selection.length;
    },

    _updateGeometry: function() {
      var list = this._getList();
      list.style.height = this._calculatedHeight();
      list.notifyResize();
    },

    _calculatedHeight: function() {
      return (window.innerHeight - this.$.controls.clientHeight - 68) + 'px';
    },

    _showSpinner: function() {
      var body = document.querySelector('body');
      this._spinner = document.createElement('spinner-backdrop');
      this._spinner.loading = true;
      this._spinner.customStyle['--spinner-backdrop-overlay-color'] = 'rgba(0,0,0,0.5)';
      Polymer.dom(body).appendChild(this._spinner);
    },

    _hideSpinner: function() {
      if (this._spinner && this._spinner.loading) {
        this._spinner.loading = false;
      }
    },

    _selectAllComplete: function() {
    },

  };
</script>

