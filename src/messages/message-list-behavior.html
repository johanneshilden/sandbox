<script>
  MessageListBehavior = {

    properties: { 
      messages: {
        type: Array,
        value: [],
      },
      selection: {
        type: Array,
      },
      selectionSize: {
        type: Number,
        computed: '_computedSelectionSize(selection.*)',
        notify: true,
      },
      hasSelection: {
        type: Boolean,
        computed: '_computedHasSelection(selection.*)',
        notify: true,
      },
    },

    onSelectAll: function() {
      var messages = this.filtered || this.messages;
      var list = this._getList();
      this._process(messages, function(item) {
        list.selectItem(item);
      }, function() {
        this._selectAllComplete();
      });
    },

    onUnselectAll: function() {
      this._getList().clearSelection();
      this.selection = [];
    },

    onSelectedToggled: function(e) {
      var list = this._getList();
      e.model.selected ? list.deselectItem(e.model.index) 
                       : list.selectItem(e.model.index);
    },

    onShowDetails: function(e) {
      var details = this.$.details;
      Polymer.dom(document.querySelector('body')).appendChild(details);
      var item = e.model.item;
      details.index = e.model.index;
      details.content = item.content;
      details.timestamp = item.timestamp;
      details.sender = item.endpoint;
      details.open();
    },

    onDeleteSelection: function() {
      var dialog = this.$['confirm-delete-dialog'];
      Polymer.dom(document.querySelector('body')).appendChild(dialog);
      dialog.open();
    },

    notifyResize: function() {
      this._getList().notifyResize();
    },

    onResize: function() {
      this._updateGeometry();
    },

    _computedSelectionSize: function() {
      return this.selection.length;
    },

    _computedHasSelection: function() {
      return !!this.selection.length;
    },

    _updateGeometry: function() {
      var list = this._getList();
      list.style.height = this._calculatedHeight();
      list.notifyResize();
    },

    _calculatedHeight: function() {
      return (window.innerHeight - this.$.controls.clientHeight - 68) + 'px';
    },

    _showSpinner: function() {
      var body = document.querySelector('body');
      this._spinner = document.createElement('spinner-backdrop');
      this._spinner.loading = true;
      this._spinner.customStyle['--spinner-backdrop-overlay-color'] = 'rgba(0,0,0,0.5)';
      Polymer.dom(body).appendChild(this._spinner);
    },

    _hideSpinner: function() {
      if (this._spinner && this._spinner.loading) {
        this._spinner.loading = false;
      }
    },

    _selectAllComplete: function() {},

    _process: function(selection, chunk, done, size) {
      if (!size) {
        size = 211;
      }
      var i = 0; 
      var processChunk = function() {
        var items = selection.slice(i, i + size);
        items.forEach(chunk, this);
        i += items.length;
        if (i < selection.length) {
          if (!this._spinner || !this._spinner.loading) {
            this._showSpinner()
          }
          window.setTimeout(processChunk, 2);
        } else {
          console.log('== process all complete ==');
          if ('function' === typeof (done)) {
            done.call(this);
          }
          this._hideSpinner();
        }
      }.bind(this);
      if (selection.length) {
        processChunk();
      }
    },

  };
</script>

