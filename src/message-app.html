<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="box/message-handler.html">
<link rel="import" href="channels/channel-list.html">
<link rel="import" href="messages/message-inbox.html">
<link rel="import" href="messages/message-outbox.html">

<dom-module id="message-app">
  <template>
    <style include="iron-flex"></style>
    <style>

      paper-tabs {
        background-color: rgb(0, 188, 212); 
        color: #fff;
        width: 100vw;
        height: 68px;
        --paper-tabs-selection-bar-color: var(--paper-pink-a200); 
      }

      paper-tab {
        --paper-tab-ink: rgba(255, 255, 255, 0.7);
      }

      paper-badge {
        margin-left: 41px;
        margin-top: -53px;
        position: absolute;
      }

      paper-fab {
        position: fixed;
        right: 30px;
        bottom: 30px;
        --paper-fab-background: rgb(0, 188, 212); 
      }

      paper-fab.scroll-button {
        right: 38px;
        bottom: 155px;
        color: rgba(0, 0, 0, .87);
        --paper-fab-background: white;
        --paper-fab-keyboard-focus-background: #f4f4f4;
      }

      iron-pages {
        height: 100%;
      }

      iron-icon, label {
        padding: 2px;
        margin-top: -2px;
      }

      label {
        text-transform: uppercase;
      }

    </style>
    <message-handler 
      id         = "message-handler"
      on-open    = "handleConnectionOpened"
      on-close   = "handleConnectionClosed"
      on-message = "handleMessage"
      on-error   = "handleError">
    </message-handler>
    <iron-iconset-svg name="custom" size="24">
      <svg>
        <defs>
          <g id="outbox">
            <path fill="#ffffff" d="M14,14H10V11H8L12,7L16,11H14V14M16,11M5,15V5H19V15H15A3,3 0 0,1 12,18A3,3 0 0,1 9,15H5M19,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3" />
          </g>
        </defs>
      </svg>
    </iron-iconset-svg>
    <app-header-layout fullbleed>
      <app-header fixed>
        <paper-tabs selected="{{tab}}">
          <paper-tab>
            <div class="layout vertical center">
              <iron-icon icon="av:volume-up"></iron-icon>
              <label>Mixer</label>
            </div>
          </paper-tab>
          <paper-tab>
            <div class="layout vertical center">
              <iron-icon icon="communication:message"></iron-icon>
              <label>SMS Inbox
                <paper-badge 
                  for     = "number"
                  hidden$ = "[[!unread]]"
                  label   = "[[unread]]">
                </paper-badge>
              </label>
            </div>
          </paper-tab>
          <paper-tab>
            <div class="layout vertical center">
              <iron-icon icon="custom:outbox"></iron-icon>
              <label>Sent SMS</label>
            </div>
          </paper-tab>
        </paper-tabs>
      </app-header>
      <iron-pages selected="[[tab]]">
        <div>
          <channel-list></channel-list>
          <paper-fab icon="communication:dialpad"></paper-fab>
        </div>
        <message-inbox 
          id              = "inbox"
          on-message      = "sendMessage"
          unread          = "{{unread}}"
          messages        = "[[inbox]]">
        </message-inbox>
        <message-outbox
          id              = "outbox"
          on-message      = "sendMessage"
          messages        = "[[outbox]]">
        </message-outbox>
      </iron-pages>
    </app-header-layout>
  </template>
  <script>

    Polymer({

      is: 'message-app',

      properties: {
        tab: {
          type: Number,
          value: 0,
          notify: true,
        },
        inbox: {
          type: Array,
          value: [],
        },
        outbox: {
          type: Array,
          value: [],
        },
        unread: {
          type: Number,
          value: 0,
        },
      },

      ready: function() {
      },

      send: function(event, data) {
        this.$['message-handler'].send({event: event, data: data});
      },

      handleConnectionOpened: function() {
        this.send('inboxFetch', {
          filter: [], 
          after_id: null,
          count: 1000,
        });
      },

      handleConnectionClosed: function() {
        console.log('handleConnectionClosed()');
      },

      handleMessage: function(event, payload) {
        console.log(payload);
        switch (payload.event) {
          case 'inboxMessages':
            var messages = payload.data.messages;
            var ids = payload.data.ids, inbox = [], outbox = [];
            ids.forEach(function(id) {
              var message = messages[id];
              message.id = id;
              if ('sms_in' == message.type) {
                inbox.push(message);
              } else {
                outbox.push(message);
              }
            });
            console.log('in  : ' + inbox.length);
            console.log('out : ' + outbox.length);
            this.set('inbox', inbox.reverse());
            this.set('outbox', outbox.reverse());
            break;
          case 'inboxUpdate':
            var only = null, count = 0;
            Object.keys(payload.data).forEach(function(key) {
              var message = payload.data[key];
              message.id = key;
              this.push('sms_in' === message.type ? 'inbox' : 'outbox', message);
              if ('sms_in' === message.type) {
                only = 1 == ++count ? message : null;
              }
            }, this);
            var toast = document.createElement('paper-toast');
            toast.text = only ? 'New message from ' 
                              + only.endpoint + ': ' 
                              + this._truncated(only.content, 60)
                              : count + ' new messages!';
            document.body.appendChild(toast); 
            toast.show();
            break;
          case 'initialize':
            console.log("              .,,,''''''',,\n         .,,,/           ,~~~\\.     /~~~\\     \\   \\\n/     __/               /      \\_'''',,,/     ))  ))\n\\_O--/                  |       \\    __ \",,  //  //\n    |                    /  \\_  /     @)  ''//_ //\n   |                      ',,,/      ~~    //  ~~__\n   |          )             (           __//        ---___ _/OO\n    \\          )     /    )   ( ,,,,   (_Q   '''----_______,_/\n      \\       |--.-- #|   |,,,/\\_   ~~\\/\n        \\____________#| /    \\_ ''\\___\n         /  /    _/  /         ~~\\ __ \\\n        /__/   #|__/                 |##\n        |##    ~~");
            break;
          case 'channelUpdate':
          default:
            console.warn('Unhandled message type: ' + payload.event);
        }
      },

      handleError: function() {
        console.log('handleError()');
      },

      sendMessage: function(e) {
        this.$['message-handler'].send(e.detail);
      },

      _truncated: function(str, lim) {
        return (str.length > lim) ? str.substring(0, lim) + 'â€¦' : str;
      },

    });

  </script>
</dom-module>
